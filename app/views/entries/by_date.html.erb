<% feed_autodiscovery entries_path(:format => :rss) %>

<% title "Entries for #{@publication_date.to_formatted_s(:pretty)}" %>
<h1 class="title"><span><%= @publication_date %> Issue</span></h1>

<%= render :partial => "statistics_by_date", :locals => {:issue => @issue} %>

<div id="content_area">

<% @agencies.each do |agency| %>
  <div class="title_bar">
    <%# HELP-DESIGN: the count here might need styling %>
    <h2 id="<%= agency.slug %>"><%= link_to agency.name, agency_path(agency) %> <span class="count"><%= agency.entries.to_a.size %></span></h2>
    <a href="#entries" class="back_to_top">Back to Top</a>
  </div>
  
  <% sub_agencies_on_this_page = @agencies & agency.children %>
  <% if sub_agencies_on_this_page.present? %>
    <ul>
      <% sub_agencies_on_this_page.each do |sub_agency| %>
        <%# HELP-DESIGN: the count here should be styled %>
        <li><span class="see">See</span> <%= link_to sub_agency.name, '#' + sub_agency.slug %> <span class="count"><%= sub_agency.entries.to_a.size %></span></li>
      <% end %>
    </ul>
  <% end %>
  
  <% agency.entries_excluding_subagency_entries.group_by(&:entry_type).each do |type, entries_by_type| %>
    <h3><%= type.pluralize %></h3>
    <dl>
    <% entries_by_type.group_by(&:toc_subject).each do |toc_subject, entries_by_toc_subject| %>
      <% if toc_subject.present? %>
        <dt><%= toc_subject %></dt>
        <% entries_by_toc_subject.sort_by(&:toc_doc).each do |entry| %>
        <dd>
          <%= render :partial => 'entry_with_page_and_frdoc', :locals => {:entry => entry } %>
        </dd>
        <% end %>
      <% else %>
        <% entries_by_toc_subject.sort_by(&:title).each do |entry| %>
        <dt>
          <%= render :partial => 'entry_with_page_and_frdoc', :locals => {:entry => entry } %>
        </dt>
        <% end %>
      <% end %>
    <% end %>
    </dl>
  <% end %>
<% end %>


<% if @entries_without_agency.present? %>
  <%# THESE SHOULD NOT EXIST AT LAUNCH; NO STYLE NECESSARY %>
  <h2>Entries without agencies</h2>
  <% @entries_without_agency.group_by(&:agency_names).each do |agency_names, entries| %>
    <h3><%= agency_names.map(&:name).to_sentence %></h2>
    <ul>
    <% entries.each do |entry| %>
      <li><%= link_to entry.title, entry_path(entry) %></li>
    <% end %>
    </ul>
  <% end %>
<% end %>

</div> <!-- END CONTENT AREA -->



<%# TODO HELP-DESIGN move this to the top of the markup and then pull it over %>
<% aside_tag(:id => 'sidebar') do %>  
  <%= render :esi => entries_by_month_path(@publication_date, :current_date => @publication_date.to_s(:iso)) %>

    <% section_tag(:id => 'meta_toc') do %>
    <div class="TOC aside_box">
      
      <div class="download_separator">
        <%= link_to 'Download PDF', issue_pdf_url(@publication_date), :class => 'button format list pdf' %>        
      </div>  
      <ul>
        <% @agencies.each do |agency| %>
          <li>
            <a href="#<%= agency.slug %>"><%= agency.name %></a> 
            <span><%= agency.entries.to_a.size %></span>
          </li>
        <% end -%>
      </ul>
    </div>    
  <% end -%>  
<% end -%>


<% if false %>
  
  <% if @map.present? %>
    <h3>Locations Mentioned</h3>
    <% add_javascript { @map.to_js } %>
    <div id="map" class='small_map'></div>
  <% end %>
  
  <h3>Today's Article Types</h3>
  <%= render :partial => 'entries/charts/by_type', :locals => {:entries => @entries} %>
  
  <h3>Top Agencies Reporting</h3>
  <%= render :partial => 'entries/charts/by_agency', :locals => {:agencies => @agencies, :entry_count => @entries.count} %>
<% end %>