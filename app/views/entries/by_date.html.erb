<% feed_autodiscovery entries_path(:format => :rss) %>

<h2>
  Entries for <%= @publication_date.to_formatted_s(:pretty) %>
  <span>(<%= pluralize(@entry_count, 'entry') %>)</span>
</h2>

<ul>
<% @agencies.group_by{|a| a.parent_id || a.id}.each do |parent_agency_id, agencies| %>
  <% agencies = agencies.sort{|a| (a.id == parent_agency_id) ? 1 : 0 } %>
  <% parent_agency = agencies.pop %>
  <li class="parent_agency">
    <h3><%= link_to parent_agency.name, agency_path(parent_agency) %> (<%= parent_agency.entries.size%>)</h3>
    <ul>
    <% parent_agency.entries.each do |entry| %>
      <li><%= link_to truncate(entry.title, :length => 100), entry_path(entry) %></li>
    <% end %>
    
    <% agencies.each do |agency| %>
      <li class="agency">
        <h4><%= link_to agency.name, agency_path(agency) %> (<%= agency.entries.size%>)</h4>
        <ul>
          <% agency.entries.each do |entry| %> 
            <li><%= link_to truncate(entry.title, :length => 100), entry_path(entry) %></li>
          <% end %>
        </ul>
      </li>
    <% end %>
    </ul>
  </li>
<% end %>
  <% if @entries_without_agency.size > 0 %>
  <li class="parent_agency">
    <h3>Other Entries (<%= @entries_without_agency.size %>)</h3>
    <ul>
    <% @entries_without_agency.each do |entry| %>
      <li><%= link_to truncate(entry.title, :length => 100), entry_path(entry) %></li>
    <% end %>
    </ul>
  </li>
  <% end %>
</ul>

<% content_for :sidebar do %>
  <h3>Top Agencies Reporting</h3>
  <%= pie_3d_chart(:alt => 'Top Agencies Reporting', :legend => @labels, :truncate_legend => '30', :counts => true, :legend_location => 'bottom', :data => @values, :size => ['230','350'], :color_range => ['005b81','c5eef5'], :transparent_bg => true) %>
  
  <h3>Locations Mentioned<h3>
  <% add_javascript { @map.to_js } %>
  <div id="map" style="width: 230px; height: 350px"></div>
<% end %>