<% title @entry.title %>

<h1 class="title"><span><%= @entry.entry_type %></span></h1>

<div id="content_area">
  
  <% if @entry.comment_url.present? && (@entry.comments_close_on.nil? || @entry.comments_close_on >= Date.today) %>
  <div id="flash_message">
    <p>This article has a comment period that ends in <%= pluralize (@entry.comments_close_date.date - Entry.latest_publication_date), 'day' %>
    (<%= @entry.comments_close_date.date %>)</p>
  </div>
  <% end -%>
  
  <% article_tag do %>

    <h1><%= @entry.title %></h1>
    <p class="metadata">A <%= @entry.entry_type %> by <%= @entry.agencies_exluding_parents.map{|a| "the #{link_to a.name, agency_path(a)}" }.to_sentence %> on   
      <%# TODO HELP-RUBY date_tag is plopped outside the P tag. maybe make datetag a span instead? %>
      <%#= date_tag(entry.publication_date, :datetime => entry.publication_date.to_s(:iso)) %>
    </p>
       
    <% content_for :javascripts do %>
    <link rev="canonical" type="text/html" href="<%= short_entry_url(@entry) %>" />
    <% end %>

    <%= render :partial => 'timeline', :locals => {:regulatory_plan => @entry.most_recent_regulatory_plan} if @entry.most_recent_regulatory_plan %>

    <% if @entry.has_full_xml? %>
      <%=
       if @entry.graphic_usages.count > 0
         html = transform_xml(@entry.full_xml, 'entries/_full_text_with_images.html.xslt').to_s
       else
         html = transform_xml(@entry.full_xml, 'entries/_full_text.html.xslt').to_s
       end
       html = auto_link(html, :href_options => { :class => 'external' })
       add_citation_links(html) %>
    <% elsif @entry.full_text %>

    <% if @entry.abstract %>
      <% section_tag(:class => 'summary') do %>
        <h3>Summary</h3>
        <p class='abstract'>
          <%= text_with_links(@entry, @entry.abstract) %>
        </p>
      <% end -%>
    <% end %>

    <h3>Full text</h3>
    <div class="fulltextWrapper">
      <pre><%=
        # FIXME: move out of view!
        text = @entry.full_text
    
        text.sub!(/.*^-{71}$/m, '')
        text.gsub!(/<\/?INF>/, '')
        text.gsub!(/\[deg\]/, '&deg;')
        text.gsub!(/<A HREF="[^"]+">\s*([^<]+)<\/A>/, 'http://\1')
        text.gsub!(/^\[GRAPHIC\].*/, '')
        text.gsub!(/\s+\[\[Page \d+\]\]\s*/m, " ")
        # text.gsub!(/\n\n([A-Z].*(?:\n^\S.*)*)/, "\n\n<h3>\\1</h3>")
        # text.gsub!(/^    (.+(?:\n^\S.*)*)/, "<p>\\1</p>\n")
        text = add_citation_links(text)
        text.sub!(/<\/pre>.*/m, '')
    
        text.sub!(/\A\s+/, '')
        text.sub!(/\s+\Z/, '')
        text
      -%>
      </pre>
    </div>


    <% if @entry.url_references.present? %>
      <h3>References</h3>
      <ul class='references'>
      <% urls = @entry.url_references.map{|ref| ref.url} %>
      <% urls.group_by(&:active).each do |active, urls| %>
        <li>
          <%= active ? 'Active' : 'Broken' %>
          <ul>
          <% urls.each do |url| %>  
            <li><%= link_to url.name, "#{url.name}" %></li>
          <% end %>
          </ul>
        </li>
      <% end  %>
      </ul>
    <% end %>

    <% end %>

  <% end -%>
</div>

<% aside_tag(:id => 'sidebar') do %>
  <% if @entry.comment_url.present? && (@entry.comments_close_on.nil? || @entry.comments_close_on >= Date.today) %>
    <% section_tag(:class => 'comment') do %>
      <div class="title_bar">
        <h2><span class="small_stack">You<span>Can</span></span><span class="large_flow">Participate</span></h2>
      </div>
      
      
      <p>The agency is required to respond in a future Federal Register article.</p>
      
      <%= link_to "Submit a formal comment", @entry.comment_url, :class => 'comments_close', :target => '_blank' %>
    <% end %>
  <% end -%>

  <% section_tag(:class => 'other_versions') do %>
  <div class="title_bar">
    <h2><span class="small_stack">View<span> in other</span></span><span class="large_flow">Formats</span></h2>
  </div>
    
    <p>This article is available in the following formats: </p>
    
    <%= %w(html pdf xml).map{|format| link_to "#{format}", @entry.source_url(format), :class => "button list #{format}" } %>
  <% end -%>


  <% section_tag(:class => 'other_versions') do %>
  <div class="title_bar">
    <h2><span class="small_stack">Pass it<span> along &amp;</span></span><span class="large_flow">Share</span></h2>
  </div>
    
    <p>Share this article via your social network of choice. <%= link_to short_entry_url(@entry), short_entry_url(@entry) %> 
    <%= clippy(short_entry_url(@entry)) %></p>
    
    <%= link_to_twitter(@entry) %>
    <%= link_to_facebook(@entry) %>
    <%= link_to_digg(@entry) %>
    <%= link_to_reddit(@entry) %>
    <a href="#" class="button list email">E-Mail</a>

  <% end -%>

  
<% end %>
