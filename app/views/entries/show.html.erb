<!-- 
citation             :string(255)
document_number      :string(255)
toc_subject          :string(255)
toc_doc              :string(255)
places_determined_at :datetime -->

<%# title 'Entries' %>

<h3>Title</h3>
<p><%= @entry.title %></p>

<div class="mod group">
  <h3>Info</h3>
  <div class="meta">
    <ul class='meta'>
      <li><%= @entry.publication_date.to_formatted_s(:pretty) %></li>
      <li>
        <%= display_agencies_for_entries(@entry) %>
      </li>
    </ul>
  </div>
  <div class="details">
    <h3>Details</h3>
    <dl class='fixed details group'>
        <dt>Federal Register Document Number:</dt> 
        <dd><%= @entry.document_number %> 
        (<% [:html, :text, :pdf].each do |format| %>
         <%= link_to format, @entry.source_url(format), :class => format %>
         <% end %>)
         </dd>
         
      <% if !@entry.dates.nil?          %><dt>Dates:</dt>          <dd><%= @entry.dates                   %></dd><% end %>
      <% if !@entry.effective_date.nil? %><dt>Effective Date:</dt> <dd><%= @entry.effective_date          %></dd><% end %>
      <% if !@entry.action.nil?         %><dt>Action:</dt>         <dd><%= @entry.action.titlecase        %></dd><% end %>
      <% if !@entry.type.nil?           %><dt>Type: </dt>          <dd><%= @entry.type                    %></dd><% end %>
      <% if !@entry.genre.nil?          %><dt>Genre:</dt>          <dd><%= @entry.genre.titlecase         %></dd><% end %>
      <% if !@entry.part_name.nil?      %><dt>Part Name:</dt>      <dd><%= @entry.part_name               %></dd><% end %>
      <% if !@entry.granule_class.nil?  %><dt>Granule Class:</dt>  <dd><%= @entry.granule_class.titlecase %></dd><% end %>
    </dl>
  </div>
</div>



<% unless @entry.url_references.blank? %>
  <h3>References</h3>
  <ul class='references'>
  <% urls = @entry.url_references.map{|ref| ref.url} %>
  <% urls.group_by(&:active).each do |active, urls| %>
    <li>
      <%= active ? 'Active' : 'Broken' %>
      <ul>
      <% urls.each do |url| %>  
        <li><%= link_to url.name, "#{url.name}" %></li>
      <% end %>
      </ul>
    </li>
  <% end  %>
  </ul>
<% end %>

<h3>Abstract</h3>
<p class='abstract'>
	<% 
	  abstract = @entry.abstract 
	  @entry.referenced_dates.each do |date|
	  	abstract.gsub!(/#{Regexp.escape(date.string)}/, link_to(date.string, calendar_by_ymd_path(date)) )
	  end
	%>
	<%= abstract %>
</p>

<ul class='date_reference'>
<% @entry.referenced_dates.each do |date| %>
  <li><%= date.date %></li>
<% end %>
</ul> 

<%=
  if @entry.full_text_raw 
    # FIXME: move out of view!
    text = @entry.full_text_raw
    text.gsub!(/.*(?:SUPPLEMENTARY INFORMATION|BACKGROUND|Background):/m, '')
    text.gsub!(/<\/pre>.*/m, '')
    text.gsub!(/<\/?INF>/, '')
    text.gsub!(/\[deg\]/, '&deg;')
    text.gsub!(/<A HREF="[^"]+">\s*([^<]+)<\/A>/, 'http://\1')
    text.gsub!(/^\[GRAPHIC\].*/, '')
    text.gsub!(/\s+\[\[Page \d+\]\]\s*/m, " ")
    text.gsub!(/\n\n([A-Z].*(?:\n^\S.*)*)/, "\n\n<h3>\\1</h3>")
    text.gsub!(/^    (.+(?:\n^\S.*)*)/, "<p>\\1</p>\n")
    text.gsub!(/((\d+) U\.?S\.?C\.? (\d+))/, '<a href="http://frwebgate.access.gpo.gov/cgi-bin/getdoc.cgi?dbname=browse_usc&docid=Cite:+\2USC\3" class="usc external" target="_blank">\1</a>')
    text.gsub!(/((\d+) CFR (\d+)(?:\.(\d))?)/, '<a href="http://frwebgate.access.gpo.gov/cgi-bin/get-cfr.cgi?YEAR=current&TITLE=\2&PART=\3&SECTION=\4&SUBPART=&TYPE=TEXT">\1</a>')
    text.gsub!(/((\d+) FR (\d+))/, '<a href="/citation/\2/\3" class="fr">\1</a>')
    text
  end %>

<%= calendar_view(@entry, :tri) %>

<% content_for :sidebar do %>
  <% unless @entry.contact.blank? %>
    <h3>Contact:</h3>
    <p><%= @entry.contact %></p>
  <% end %>

  <% unless @entry.topics.blank? %>
    <h3>Topics:</h3>
    <ul>
      <% @entry.topics.each do |topic| %>
        <li><%= link_to topic.name, topic_path(topic) %></li>
      <% end %>
    </ul>  
  <% end %>

  
  <h3>Document</h3>
  <ul class='document'>
    <li>Length:     <%= pluralize(@entry.human_length, 'page') %></li>
    <li>Start Page: <%= @entry.start_page                      %></li>
    <li>End Page:   <%= @entry.end_page                        %></li>
  </ul>
  

  <% unless @entry.places.blank? %>
	<h3>Entries Close By</h3>
	<% 
		distance = 10 
		entry_limit = 10
		total_entries = @entry.entries_within(distance, :count => true)
	%>
	<ul>
	<% @entry.entries_within(distance, :limit => entry_limit).each do |entry| %>
	  <li><%= link_to truncate(entry.title, 100), entry_path(entry) %></li>
	<% end %>
	</ul>
	<%# TODO: add real link here %>
	<%= link_to "View #{total_entries-entry_limit} more entries with #{distance} miles", '#' %>
  <% end %>

<% end %>
