<% title @search.term.blank? ? 'Search Articles' : "Search Results for '#{h @search.term}'" %>

<h1 class="title"><span><%= @search.term.blank? ? 'Search Articles' : "Search Results for '#{h @search.term}'" %></span></h1>


<div class="search_bar">
    <% form_for :conditions, @search, :url => entries_search_path, :html => {:method => :get} do |f| %>
      <label>Find</label>
      <%= f.text_field :term %>
      <%= f.submit 'Search' %>
    <% end %>
</div>

<% if @search.entries.size > 0 %>
  <div class="search_info titlebar">
    
    <div class="article_count">
      <%# TODO HELP-RUBY how do i get the total number in here. aka where does page_entries_info live?  %>
      <h2 class="title_bar"><span class="small_stack">Articles <span>Found</span></span>52</h2>
      <!-- <h2 class="title_bar"><span class="small_stack">Filtered <span>Search has</span></span>52</h2> -->
      <%#= page_entries_info @search.entries.count %>
    </div>
    
    <ul class="ordering">
      <% EntrySearch::SUPPORTED_ORDERS.each do |order| %>
        <li class="<%= 'on' if @search.order == order.downcase %>">
          <%= link_to order, params.merge(:order => order.downcase), :class => 'button list' %>
        </li>
      <% end %>
    </ul>
    
    <div class="actions">
      <%= link_to 'Subscribe', params.merge(:format => :rss, :order => 'date', :publication_date_less_than => nil), :class => 'button notext rss' %>
      <% feed_autodiscovery url_for(params.merge(:format => :rss, :order => 'date', :publication_date_less_than => nil)) %>
      <%= link_to 'Widget', widget_instructions_path(params.except(:action, :controller)), :class => 'button widget spawn_modal notext', :id => 'widget' %>
    </div>
  </div>
  

  <div class="filters">
    <% unless @search.blank? %>
      <%= sparkline(:data => @search.date_distribution.to_a.sort_by{|date, count| date}.map{|date, count| count}, :alt => "Monthl Distribution" ) %>

      <h3>Limit the Results</h3>
      <ul>
      <% [30, 60, 365].each do |n| %>
        <li class="<%= 'on' if @search.start_date == n.days.ago.to_date.to_s %>">
          <%= link_to "Past #{n} days (#{@search.count_in_last_n_days(n)})", params.recursive_merge(:page => nil, :conditions => {:start_date => n.days.ago.to_date}) %>
        </li>
      <% end %>
      </ul>

      <%= render :partial => "search_facets", :locals => {:facets => @search.section_facets,  :name => "Section",  :attribute => :section_ids}%>
      <%= render :partial => "search_facets", :locals => {:facets => @search.agency_facets,   :name => "Agency",   :attribute => :agency_ids}%>
      <%= render :partial => "search_facets", :locals => {:facets => @search.topic_facets,    :name => "Topic",    :attribute => :topic_ids}%>

    <% end %>
  </div>
  
  
<div class="result_set">

  <ol class="results">
    <% @search.entries.each do |entry| %>
    <li>
      <h4><%= link_to sanitize(entry.excerpts.title, :tags => %w(span), :attributes => %w(class)), entry_path(entry) %></h4>
    
      <div class="result_info">
        <span class="date"><%= entry.publication_date %></span>
        <span class="excepts"><%= 
          if @search.term.blank? || entry.excerpts.full_text.blank?
            sanitize entry.excerpts.abstract, :tags => %w(span), :attributes => %w(class)
          else
            sanitize entry.excerpts.full_text, :tags => %w(span), :attributes => %w(class)
          end %></span>
        <br />
        <span class="agency"><%= entry.agencies.map{|agency| link_to(agency.name, agency_path(agency))}.join(' :: ') %></span>
      </div>  
    </li>
    <% end %>
  </ol>
  
    <%= will_paginate @search.entries %>

<% else %>
  <p>No entries were found.</p>
<% end %>

</div>

<% content_for :widget do %>
<div id="modal_widget" class="modal_box group">
  <div class="modal_box_content">
    <%= render :partial => 'widget_instructions', :locals => { :permalink => true } %>
    <a href="" class="cancel">Close Window</a>
  </div>
</div>
<% end %>