<% if subject %>
  <li id="<%= type %>-<%= Digest::MD5.hexdigest(subject) %>">
    <span class="title"><%= subject %><span>
    <% form_tag(params, :method => :put) do %>
      <%= hidden_field_tag(:type, type) %>
      <%= hidden_field_tag(:old_subject, subject) %>
      <% entries_of_subject.map{|t,e| e}.flatten.each do |entry| %>
        <%= hidden_field_tag(:'entry_ids[]', entry.id) %>
      <% end %>
      <%= text_field_tag('entry[fr_index_subject]', subject) %>
      <%= submit_tag("Save") %>
    <% end %>
  <ul>
<% end %>

<% entries_of_subject.each do |toc_doc, entries| %>
  <% highlight_entry =  entries.select{|e| e.publication_date <= Date.today - 3.days}.size == 0 && entries.none?{|e| e.fr_index_doc || e.fr_index_subject} %>
  <li id="<%= type %>-<%= Digest::MD5.hexdigest("#{subject}#{toc_doc}")%>" class="<%= 'new_item' if highlight_entry %>">
    <a class="wrapper" href="javascript:" data-toggle="collapse" data-target="#<%= Digest::MD5.hexdigest(entries.to_s) %>">
      <span class="title"><%= toc_doc %></span>
      <span class="count_pill"><%= entries.count %></span>
    </a>

    <%= link_to 'Edit', '#', :class => "edit btn btn-mini" %>

    <ul id="<%= Digest::MD5.hexdigest(entries.to_s) %>" class="entry_details" style="height: 0px; overflow-y: hidden"> 
      <% entries.each do |entry| %>
        <li class="with_ajax_popover" data-document-number=<%= entry.document_number %>>
          <%= link_to entry.document_number, entry_path(entry) %>
          page <%= entry.start_page %>, published <%= link_to entry.publication_date, entry_path(entry) %>
        </li>
      <% end %>
    </ul>
    <% form_tag(params, :method => :put) do %>
      <%= hidden_field_tag(:type, type) %>
      <%= hidden_field_tag(:old_subject, subject || toc_doc) %>
      <% entries.each do |entry| %>
        <%= hidden_field_tag(:'entry_ids[]', entry.id) %>
      <% end %>
      <%= text_field_tag('entry[fr_index_subject]', subject, :class => "fr_index_subject") %>
      <%= text_field_tag('entry[fr_index_doc]', toc_doc, :class => "fr_index_doc") %>
      <%= submit_tag("Save") %>
    <% end %>
  </li>
<% end %>
<% if subject %>
  </ul>
<% end %>
